# Click Counter

Высокопроизводительный сервис для подсчета кликов по баннерам с использованием write-behind кэширования и шардированного in-memory хранилища.

## Архитектура

### Основные компоненты

- **Controller** - HTTP обработчики для API эндпоинтов
- **Usecase** - Бизнес-логика с кэшированием и батчингом
- **Repository** - Слой доступа к данным PostgreSQL
- **Cache** - Шардированный in-memory кэш для высокой производительности

### Принципы проектирования

- **Clean Architecture** - четкое разделение слоев через интерфейсы
- **Write-behind caching** - накопление данных в памяти с периодическим сбросом в БД
- **Шардирование** - минимизация конкуренции между горутинами
- **Батчинг** - эффективная запись в БД группами

## API

### Эндпоинты

#### Инкремент счетчика

```
GET /v1/banners/counter/{bannerID}
```

Увеличивает счетчик баннера на 1. Возвращает 204 No Content.

#### Получение статистики

```
curl -X POST -d '{"from": "2025-07-01T00:00:00Z", "to": "2025-08-01T00:00:00Z"}' -H "Content-Type: application/json" http://localhost:3000/v1/banners/stats/<ID>
```

```
POST /v1/banners/stats/{bannerID}
Content-Type: application/json

{
  "from": "2024-01-01T00:00:00Z",
  "to": "2024-01-02T00:00:00Z"
}
```

Возвращает:

```json
{
  "stats": [
    {
      "ts": "2024-01-01T10:00:00Z",
      "v": 42
    }
  ]
}
```

#### Проверка состояния (прогрев TCP)

```
GET /v1/healthcheck
```

Возвращает 200 OK.

### Требования

- Go 1.21+
- PostgreSQL 13+
- golang-migrate

### Установка и запуск

1. **Клонирование репозитория**

```bash
git clone https://github.com/aaoreshkin/click-counter.git
cd click-counter
```

2. **Настройка базы данных**

```bash
# Запуск PostgreSQL (например, через Docker)
docker run -d --name postgres \
  -e POSTGRES_PASSWORD=postgres \
  -p 5432:5432 postgres:13

# Применение миграций
./migrate.sh -up
```

3. **Запуск приложения**

```bash
./run.sh
```

Сервер будет доступен по адресу `http://localhost:3000`

## Конфигурация

### Переменные окружения

- `SERVICE_PORT` - порт HTTP сервера (по умолчанию: 3000)
- `DATABASE_URL` - строка подключения к PostgreSQL
- `DEBUG` - режим отладки (1 для включения)
- `SECRET_KEY` - секретный ключ для криптографических операций

### Настройки производительности

- **Воркеры сброса кэша**: 4 (настраивается в `internal/manager.go`)
- **Интервал сброса**: 1 секунда
- **Шарды кэша**: NumCPU \* 2 (автоматически)
- **Пул соединений БД**: NumCPU \* 5 (максимум)

## Управление миграциями

```bash
# Применить все миграции
./migrate.sh -up

# Создать новую миграцию
./migrate.sh -create add_new_table

# Откатить все миграции (ОПАСНО!)
./migrate.sh -down

# Перейти к конкретной версии
./migrate.sh -goto 1

# Исправить состояние после ошибки
./migrate.sh -fix 1
```

## Производительность

### Оптимизации

- **Шардированный кэш** - снижение конкуренции между горутинами
- **Батчинг записи** - группировка операций для БД
- **UPSERT операции** - агрегация данных по минутам
- **Пул соединений** - переиспользование подключений к БД
- **TCP Keep-Alive** - быстрое обнаружение обрывов связи

### Характеристики

- **Латентность инкремента**: < 1ms (в памяти)
- **Пропускная способность**: > 100K RPS на одно ядро
- **Потери данных**: максимум 1 секунда при сбое
- **Масштабируемость**: линейная по количеству CPU ядер

## Мониторинг

### Логирование

Приложение выводит структурированные логи с информацией о:

- Запуске/остановке сервиса
- Ошибках подключения к БД
- Результатах миграций

### Метрики

Нагрузка через [Vegeta](https://github.com/tsenart/vegeta)

```
echo "GET http://localhost:3000/v1/banners/counter/3" | vegeta attack -duration=1s -rate=100000 | tee result.bin | vegeta report
```

```
Requests      [total, rate, throughput]         99999, 100005.36, 96524.82
Duration      [total, attack, wait]             1.036s, 999.936ms, 36.056ms
Latencies     [min, mean, 50, 90, 95, 99, max]  41.354µs, 24.031ms, 12.694ms, 61.688ms, 82.76ms, 123.266ms, 290.243ms
Bytes In      [total, mean]                     0, 0.00
Bytes Out     [total, mean]                     0, 0.00
Success       [ratio]                           100.00%
Status Codes  [code:count]                      204:99999
Error Set:
```

## Разработка

### Структура проекта

```
├── cmd/                   # Точка входа приложения
├── internal/
│   ├── banners/           # Модуль баннеров
│   │   ├── controller/    # HTTP обработчики
│   │   ├── usecase/       # Бизнес-логика
│   │   ├── repository/    # Доступ к данным
│   │   └── model/         # Модели и интерфейсы
│   ├── provider/          # Провайдеры (БД, кэш)
│   └── router/            # HTTP роутинг
├── migrations/            # SQL миграции
├── lib/                   # Утилиты и скрипты
└── common/                # Общие функции
```

### Добавление нового модуля

1. Создать структуру папок по аналогии с `banners/`
2. Реализовать интерфейсы в `model/`
3. Добавить роуты в `router/routes.go`
4. Зарегистрировать в `internal/manager.go`

## Безопасность

### Рекомендации для продакшена

- Использовать SSL для подключения к БД (`sslmode=require`)
- Установить статический `SECRET_KEY`
- Настроить файрвол для ограничения доступа
- Использовать reverse proxy (nginx/traefik)
- Настроить мониторинг и алерты

### Переменные окружения

В продакшене обязательно установить:

```bash
export DEBUG=0
export DATABASE_URL="postgres://user:pass@host:5432/db?sslmode=require"
export SECRET_KEY="your-static-secret-key"
```

## Лицензия

MIT License
