# Migrations

Этот каталог содержит SQL миграции для управления схемой базы данных проекта.

## Структура файлов

Миграции создаются парами:

- `{timestamp}_{name}.up.sql` - применение изменений
- `{timestamp}_{name}.down.sql` - откат изменений

## Текущие миграции

### 20250707110549_banners_counter

**Назначение**: Создание основной таблицы для хранения счетчиков баннеров

**Что создает (up.sql)**:

- Партиционированная таблица `banners_counter` с полями:
  - `banner_id` - ID баннера
  - `ts` - временная метка (агрегация по минутам)
  - `v` - значение счетчика
- Индексы для оптимизации запросов
- Месячные партиции для масштабируемости
- Партиция по умолчанию для неожиданных дат

**Что удаляет (down.sql)**:

- Полностью удаляет таблицу `banners_counter`
- Автоматически удаляет все партиции и индексы

## Архитектурные решения

### Партиционирование

- **По времени (RANGE)** - для эффективного архивирования старых данных
- **Месячные партиции** - баланс между производительностью и управляемостью
- **Партиция по умолчанию** - предотвращение ошибок при неожиданных датах

### Индексы

- **По banner_id** - быстрый поиск статистики конкретного баннера
- **По времени** - эффективная фильтрация по временным диапазонам
- **Частичный по значению** - только для записей с кликами (экономия места)

### Составной первичный ключ

- `(banner_id, ts)` - обеспечивает уникальность и быстрый доступ
- Поддерживает UPSERT операции для агрегации данных

## Управление миграциями

### Применение миграций

```bash
# Применить все новые миграции
./migrate.sh -up

# Перейти к конкретной версии
./migrate.sh -goto 20250707110549
```

### Создание новых миграций

```bash
# Создать новую миграцию
./migrate.sh -create add_banner_metadata

# Это создаст файлы:
# migrations/{timestamp}_add_banner_metadata.up.sql
# migrations/{timestamp}_add_banner_metadata.down.sql
```

### Откат миграций

```bash
# ОПАСНО: Откатить все миграции
./migrate.sh -down

# Исправить состояние после ошибки
./migrate.sh -fix 20250707110549
```

## Управление партициями

### Автоматическое создание

В продакшене рекомендуется использовать:

- **pg_partman** - для автоматического управления партициями
- **Cron задачи** - для создания партиций заранее
- **Мониторинг** - размера партиций и производительности

### Пример создания новой партиции

```sql
-- Создание партиции на июль 2025
CREATE TABLE banners_counter_2025_02 PARTITION OF banners_counter
FOR VALUES FROM ('2025-07-01') TO ('2025-08-01');
```

### Удаление старых партиций

```sql
-- Удаление партиции за июль 2025 (после архивирования)
DROP TABLE IF EXISTS banners_counter_2025_07;
```

## Мониторинг

### Полезные запросы

```sql
-- Размеры партиций
SELECT
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE tablename LIKE 'banners_counter_%'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- Статистика по партициям
SELECT
    schemaname,
    tablename,
    n_tup_ins as inserts,
    n_tup_upd as updates,
    n_tup_del as deletes
FROM pg_stat_user_tables
WHERE tablename LIKE 'banners_counter_%';
```
